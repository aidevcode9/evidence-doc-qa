name: deploy-backend

on:
  push:
    branches: ["main"]
    paths:
      - "apps/api/**"
      - "infra/**"
      - ".github/workflows/deploy.yml"

permissions:
  id-token: write
  contents: read

jobs:
  infra-and-deploy:
    runs-on: ubuntu-latest
    env:
      RESOURCE_GROUP: doc-qa-demo
      LOCATION: northcentralus
      PREFIX: docqa
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Provision Infrastructure
        id: provision
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.RESOURCE_GROUP }}
          template: ./infra/main.bicep
          parameters: >
            prefix=${{ env.PREFIX }}
            location=${{ env.LOCATION }}
            dbAdminPassword=${{ secrets.DB_ADMIN_PASSWORD }}
            vercelUrl=${{ secrets.VERCEL_URL }}
          failOnStdErr: false

      - name: Get Infrastructure Outputs
        run: |
          echo "ACR_NAME=${{ steps.provision.outputs.acrName }}" >> $GITHUB_ENV
          echo "ACR_LOGIN_SERVER=${{ steps.provision.outputs.acrLoginServer }}" >> $GITHUB_ENV
          echo "WEB_APP_NAME=${{ steps.provision.outputs.webAppName }}" >> $GITHUB_ENV

      - name: Log in to ACR
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Build and Push API Image
        run: |
          docker build -t ${{ env.ACR_LOGIN_SERVER }}/docqa-api:${{ github.sha }} -t ${{ env.ACR_LOGIN_SERVER }}/docqa-api:latest -f apps/api/Dockerfile apps/api
          docker push ${{ env.ACR_LOGIN_SERVER }}/docqa-api:${{ github.sha }}
          docker push ${{ env.ACR_LOGIN_SERVER }}/docqa-api:latest

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.WEB_APP_NAME }}
          images: ${{ env.ACR_LOGIN_SERVER }}/docqa-api:${{ github.sha }}